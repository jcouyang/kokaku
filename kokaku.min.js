var extend=function(a){var b,c=this;b=function(){c.apply(this,arguments)},b.parent=c;var d=function(){this.constructor=b};return d.prototype=c.prototype,b.prototype=new d,_.extend(b,c),_.extend(b.prototype,a),b};Model=function(a,b){this.name=a,this.local=Q.defer(),this.updated=Q.defer(),this.localData={},this.url=b,this.initialize.apply(this,arguments)},Model.extend=extend,_.extend(Model.prototype,{initialize:function(){},storage:localStorage,get:function(a){var b=this.storage.getItem(this.name);return b&&JSON.parse(b)[a]},fetch:function(){var a=this;this.localData=JSON.parse(this.storage.getItem(this.name)),this.localData&&this.local.resolve(this.localData),this.refetch().then(function(b){a.local.resolve(b),_.isEqual(b,a.localData)||(a.updated.resolve(b),a.save(b),a.localData=b)},function(){a.local.reject(),a.updated.reject()})},refetch:function(){var a=this;if(!this.url)return Q();var b=this.url.split("@");return Q($.ajax(_.extend({url:b[1],method:b[0]},a.dataOptions)))},save:function(a){this.storage.setItem(this.name,JSON.stringify(a))}}),View=function(){this.initialize.apply(this,arguments)},View.extend=extend;var delegateEventSplitter=/^(\S+)\s*(.*)$/;_.extend(View.prototype,{el:$("body"),templateEngine:nunjucks,template:"",model:Model,events:"click body:",initialize:function(){arguments[0]&&_.extend(this,arguments[0]),this.model.fetch()},preProcessData:function(a){return a},render:function(a){var b=this;this.model.local.promise.then(function(c){c=b.preProcessData(c);var d=b.templateEngine.render(b.template,{data:_(c).extend(a)});b.el.html(d),b.bindEvent()},function(){b.el.html(b.templateEngine.render(b.template))}),this.model.updated.promise.then(function(c){c=b.preProcessData(c),b.el.html(b.templateEngine.render(b.template,{data:_(c).extend(a)})),b.bindEvent()},function(){b.el.html(b.templateEngine.render(b.template))})},refetch:function(){this.model.fetch()},bindEvent:function(){var a=this,b=_.result(this,"events");return b?void _.each(_(b).keys(),function(c){var d=c.match(delegateEventSplitter),e=d[1],f=d[2];""==f?a.el.on(e,_.bind(a[b[c]],a)):$(f).on(e,_.bind(a[b[c]],a))}):this}}),Router=function(){this.routes=[],this.params={};var a=this,b=!1,c=!1,d=!1,e=function(){var b,c=window.location.hash.replace("#","")||"/";_.each(a.routes,function(a){var d=new RegExp(a.regex,"g");return null!==(b=d.exec(c))?(console.log(b),b.shift(),void a.callback(_.object(a.paramNames,b))):void 0})};$(window).on("hashchange",function(a){b||(console.log("hashchange",document.location,a.originalEvent.state),e(a),c=!0,b=!1),d=!1}),$(window).on("popstate",function(a){d||(console.log("popstate",document.location,a.originalEvent.state),e(a),b=!0,d=!1)}),$(window).on("load",function(a){console.log("load",document.location,a.originalEvent.state),e(a),d=!0})},Router.prototype.get=function(a,b){for(var c,d=/:([^/.\\\\]+)/g,e={paramNames:[],regex:"^"+a+"$",params:{},callback:b};null!==(c=d.exec(a));)e.paramNames.push(c[1]),e.regex=e.regex.replace(c[0],"([^/.\\\\]+)");this.routes.push(e)};